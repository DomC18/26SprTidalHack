{% extends 'food_security/base.html' %}

{% block title %}Analysis Dashboard: {{ area.area_name }}{% endblock %}

{% block extra_css %}
<style>
    .score-ring {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        font-size: 2.5rem;
        font-weight: 900;
        color: white;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .score-ring-critical {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }
    
    .score-ring-severe {
        background: linear-gradient(135deg, #fd7e14, #e86e00);
    }
    
    .score-ring-moderate {
        background: linear-gradient(135deg, #ffc107, #e0a800);
    }
    
    .score-ring-mild {
        background: linear-gradient(135deg, #28a745, #1e7e34);
    }
    
    .metric-box {
        text-align: center;
        padding: 20px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 15px;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 900;
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .challenge-list {
        list-style: none;
        padding: 0;
    }
    
    .challenge-list li {
        padding: 12px 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: flex-start;
    }
    
    .challenge-list li:last-child {
        border-bottom: none;
    }
    
    .challenge-list li:before {
        content: "●";
        color: #dc3545;
        font-size: 1.5rem;
        margin-right: 12px;
        line-height: 1.4;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 15px; color: white; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin-bottom: 10px; font-size: 2.2rem;">{{ area.area_name }}</h1>
                    <p style="font-size: 1rem; opacity: 0.95; margin: 0;">
                        <i class="bi bi-geo-alt"></i> {{ area.address }}, {{ area.city }}, {{ area.state }}
                    </p>
                </div>
                <div text-align: right;">
                    <span class="severity-{{ analysis.severity_level }}" style="font-size: 1.2rem;">
                        {{ analysis.get_severity_level_display|upper }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Severity & Key Scores -->
    <div class="row mb-5">
        <div class="col-md-3 text-center">
            <div class="score-ring score-ring-{{ analysis.severity_level }}">
                <div>{{ analysis.food_insecurity_score|floatformat:0 }}</div>
                <small style="font-size: 0.6rem; opacity: 0.9;">/ 100</small>
            </div>
            <p style="margin-top: 15px; font-weight: 600; text-align: center; color: #333;">Food Insecurity Score</p>
        </div>
        <div class="col-md-3">
            <div class="metric-box">
                <div class="metric-value" style="color: #667eea;">{{ analysis.accessibility_score|floatformat:0 }}</div>
                <div class="metric-label">Accessibility</div>
                <div class="progress" style="margin-top: 10px; height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: {{ analysis.accessibility_score }}%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-box">
                <div class="metric-value" style="color: #28a745;">{{ analysis.income_adequacy_score|floatformat:0 }}</div>
                <div class="metric-label">Income</div>
                <div class="progress" style="margin-top: 10px; height: 8px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ analysis.income_adequacy_score }}%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-box">
                <div class="metric-value" style="color: #ffc107;">{{ analysis.infrastructure_score|floatformat:0 }}</div>
                <div class="metric-label">Infrastructure</div>
                <div class="progress" style="margin-top: 10px; height: 8px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ analysis.infrastructure_score }}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Information Cards -->
    <div class="row mb-5">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-danger">
                    <i class="bi bi-exclamation-circle"></i> Critical Information
                </div>
                <div class="card-body">
                    <h6 class="mb-3">Key Challenges</h6>
                    <ul class="challenge-list">
                        {% for line in analysis.key_challenges|split:"• " %}
                            {% if line|length > 5 %}
                                <li style="padding-left: 0;">{{ line }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-info">
                    <i class="bi bi-calendar-check"></i> Implementation Plan
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Estimated Investment</strong>
                        <div style="font-size: 1.3rem; color: #667eea; font-weight: 700;">{{ analysis.estimated_investment }}</div>
                    </div>
                    <div>
                        <strong>Timeline</strong>
                        <p style="color: #666; margin-top: 8px;">{{ analysis.implementation_timeline }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-success">
                    <i class="bi bi-check-circle"></i> Area Demographics
                </div>
                <div class="card-body">
                    <div class="row" style="gap: 15px;">
                        <div>
                            <small style="color: #999;">Population</small>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #333;">{{ area.population|floatformat:0 }}</div>
                        </div>
                        <div>
                            <small style="color: #999;">Poverty Rate</small>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #333;">{{ area.poverty_rate }}%</div>
                        </div>
                    </div>
                    <hr>
                    <div class="row" style="gap: 15px;">
                        <div>
                            <small style="color: #999;">Food Insecurity</small>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #333;">{{ area.food_insecurity_rate }}%</div>
                        </div>
                        <div>
                            <small style="color: #999;">Unemployment</small>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #333;">{{ area.unemployment_rate }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Plans -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Short-term Actions (0-6 Months)</h5>
                </div>
                <div class="card-body">
                    <ol style="padding-left: 20px;">
                        {% for line in analysis.short_term_actions|split:"

" %}
                            {% if line|length > 5 %}
                                <li style="margin-bottom: 10px;">{{ line|safe }}</li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success">
                    <h5 class="mb-0" style="color: white;"><i class="bi bi-target"></i> Long-term Actions (1-3+ Years)</h5>
                </div>
                <div class="card-body">
                    <ol style="padding-left: 20px;">
                        {% for line in analysis.long_term_actions|split:"

" %}
                            {% if line|length > 5 %}
                                <li style="margin-bottom: 10px;">{{ line|safe }}</li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Priority Solutions -->
    {% if analysis.priority_solutions %}
        <div class="row mb-5">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-star"></i> Priority Solutions
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;">Solution</th>
                                        <th style="width: 15%;">Category</th>
                                        <th style="width: 10%;">Priority</th>
                                        <th style="width: 10%;">Feasibility</th>
                                        <th style="width: 15%;">Cost</th>
                                        <th style="width: 20%;">Timeline</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for solution in analysis.priority_solutions|slice:":5" %}
                                        <tr>
                                            <td><strong>{{ solution.title }}</strong></td>
                                            <td><span class="category-badge">{{ solution.category }}</span></td>
                                            <td>
                                                <span class="badge" style="background: {% if solution.priority == 1 %}#dc3545{% elif solution.priority == 2 %}#fd7e14{% else %}#ffc107{% endif %};">
                                                    {{ solution.priority }}/5
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge" style="background: {% if solution.feasibility >= 4 %}#28a745{% elif solution.feasibility >= 3 %}#ffc107{% else %}#dc3545{% endif %};">
                                                    {{ solution.feasibility }}/5
                                                </span>
                                            </td>
                                            <td><small>{{ solution.cost }}</small></td>
                                            <td><small>{{ solution.timeline }} months</small></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% if analysis.priority_solutions|length > 5 %}
                    <p class="text-center mt-3">
                        <small class="text-muted">Showing 5 of {{ analysis.priority_solutions|length }} solutions</small>
                    </p>
                {% endif %}
            </div>
        </div>
    {% endif %}
    
    <!-- Detailed Recommendations -->
    {% if recommendations %}
        <div class="row mb-5">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-lightbulb"></i> Detailed Recommendations
                    </div>
                    <div class="card-body">
                        {% regroup recommendations by category as recs_by_cat %}
                        {% for group in recs_by_cat %}
                            <div class="mb-4">
                                <h6 class="text-uppercase mb-3" style="color: #667eea; font-weight: 700; letter-spacing: 0.5px;">
                                    <i class="bi bi-tag"></i> {{ group.grouper|upper }}
                                </h6>
                                {% for rec in group.list|slice:":2" %}
                                    <div class="recommendation-card p-3 mb-3 rounded border">
                                        <div class="row align-items-start">
                                            <div class="col-md-8">
                                                <h6 style="color: #333; margin-bottom: 8px;">{{ rec.title }}</h6>
                                                <p style="color: #666; font-size: 0.95rem; margin-bottom: 10px;">{{ rec.description }}</p>
                                                <span class="category-badge">{{ rec.get_category_display }}</span>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <div class="mb-2">
                                                    <small style="display: block; margin-bottom: 5px;">
                                                        <strong>Priority:</strong> <span class="badge bg-primary">{{ rec.priority }}/5</span>
                                                    </small>
                                                    <small style="display: block; margin-bottom: 5px;">
                                                        <strong>Feasibility:</strong> <span class="badge bg-success">{{ rec.feasibility }}/5</span>
                                                    </small>
                                                    <small style="display: block;">
                                                        <strong>Cost:</strong> {{ rec.estimated_cost }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    <!-- Back to Area -->
    <div class="row">
        <div class="col-md-12 text-center">
            <a href="{% url 'food_security:area-detail' area.pk %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Area Details
            </a>
        </div>
    </div>
</div>
{% endblock %}
